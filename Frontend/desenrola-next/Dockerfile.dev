# --- Base image ---
FROM node:20-alpine

# Configuração de timezone e dependências adicionais
ENV TZ=America/Fortaleza

# Instalar pacotes essenciais para compilação e hot reload
RUN apk add --no-cache \
    libc6-compat \
    bash \
    git \
    curl \
    python3 \
    make \
    g++

# Diretório de trabalho
WORKDIR /app

# Copiar apenas package.json e package-lock.json primeiro (para cache eficiente)
COPY package*.json ./

# Instalar dependências de produção + desenvolvimento (inclui Jest)
RUN npm install --include=dev

# Copiar todo o restante do código
COPY . .

# Criar diretórios necessários e ajustar permissões
RUN mkdir -p /app/.next && \
    chmod -R 755 /app && \
    chown -R node:node /app

# Rodar como usuário seguro
USER node

# Variáveis de ambiente padrão
ENV NODE_ENV=development
ENV HOST=0.0.0.0
ENV PORT=3000
ENV NEXT_TELEMETRY_DISABLED=1

# Expor a porta do Next.js
EXPOSE 3000

# Comando padrão (inicia o servidor de desenvolvimento)
CMD ["npm", "run", "dev"]