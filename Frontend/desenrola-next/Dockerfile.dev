FROM node:20-alpine

ENV TZ=America/Fortaleza

# Dependências extras para hot reload
RUN apk add --no-cache libc6-compat bash git curl python3 make g++

WORKDIR /app

# Instalar dependências primeiro
COPY package*.json ./
RUN npm install

# Copiar código (mas como no compose só bindamos src/public/package*, isso ajuda no build inicial)
COPY . .

# Criar diretórios necessários e dar permissões
RUN mkdir -p /app/.next && \
    chmod -R 755 /app && \
    chown -R node:node /app

# Usar usuário node (segurança e compatibilidade)
USER node

# Variáveis de ambiente para desenvolvimento
ENV NODE_ENV=development
ENV HOST=0.0.0.0
ENV PORT=3000
ENV NEXT_TELEMETRY_DISABLED=1

EXPOSE 3000

# Comando padrão (sobrescrito pelo docker-compose em dev)
CMD ["npm", "run", "dev"]
